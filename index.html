<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Gist Viewer</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; cursor: pointer; }
        th:hover { background-color: #ddd; }
        .sort-icon::after { content: ''; padding-left: 5px; }
        .sort-icon.asc::after { content: '\25B2'; }
        .sort-icon.desc::after { content: '\25BC'; }
        #error { color: red; }
        #loading, #pagination { text-align: center; margin-top: 20px; }
        #pagination button { margin: 0 5px; }
        .file-list { margin-top: 5px; font-size: 0.9em; color: #666; }
        #username, #fetchButton, #search { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>GitHub Gist Viewer</h1>
    <input type="text" id="username" placeholder="Enter GitHub username" aria-label="GitHub username">
    <button id="fetchButton">Fetch Gists</button>
    <input type="text" id="search" placeholder="Search by description or filename" aria-label="Search gists">
    <div id="error" role="alert"></div>
    <div id="loading"></div>
    <table id="gistsTable" aria-label="Gists table">
        <thead>
            <tr>
                <th data-sort-direction="">Description <span class="sort-icon"></span></th>
                <th data-sort-direction="">Files <span class="sort-icon"></span></th>
                <th data-sort-direction="">Created <span class="sort-icon"></span></th>
                <th data-sort-direction="">Updated <span class="sort-icon"></span></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="pagination">
        <button id="prevPage" disabled>Previous</button>
        <span id="pageInfo"></span>
        <button id="nextPage" disabled>Next</button>
    </div>

    <script>
    class GistViewer {
        constructor() {
            this.allGists = [];
            this.currentPage = 1;
            this.perPage = 100;
            this.totalPages = 1;

            this.elements = {
                username: document.getElementById('username'),
                fetchButton: document.getElementById('fetchButton'),
                search: document.getElementById('search'),
                error: document.getElementById('error'),
                loading: document.getElementById('loading'),
                table: document.getElementById('gistsTable'),
                prevPage: document.getElementById('prevPage'),
                nextPage: document.getElementById('nextPage'),
                pageInfo: document.getElementById('pageInfo')
            };

            this.init();
        }

        init() {
            this.elements.fetchButton.addEventListener('click', () => this.fetchGists());
            this.elements.search.addEventListener('input', () => this.handleSearch());
            this.elements.prevPage.addEventListener('click', () => this.changePage(-1));
            this.elements.nextPage.addEventListener('click', () => this.changePage(1));
            this.elements.username.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.fetchGists();
            });
            this.elements.table.querySelector('thead').addEventListener('click', (e) => {
                const th = e.target.closest('th');
                if (th) this.sortTable(th);
            });

            const urlParams = new URLSearchParams(window.location.search);
            const urlUsername = urlParams.get('username');
            if (urlUsername) {
                this.elements.username.value = urlUsername;
                this.fetchGists();
            }
        }

        async fetchGists() {
            const username = this.elements.username.value;
            if (!username) return this.showError('Please enter a GitHub username');

            this.showLoading(true);
            this.showError('');

            try {
                const response = await fetch(`https://api.github.com/users/${username}/gists?per_page=100`);
                if (!response.ok) throw new Error(response.status === 404 ? 'User not found' : `HTTP error! status: ${response.status}`);
                
                this.allGists = await response.json();
                this.displayGists(this.allGists);
                this.updatePagination();
                this.updateURL(username);

                // Set default sort on 'Updated' column (last column) in descending order
                const updatedColumn = this.elements.table.querySelector('th:last-child');
                this.sortTable(updatedColumn, 'desc');
            } catch (error) {
                this.showError(error.message);
            } finally {
                this.showLoading(false);
            }
        }

        handleSearch() {
            const searchTerm = this.elements.search.value.toLowerCase();
            const rows = Array.from(this.elements.table.querySelectorAll('tbody tr'));
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });

            this.updatePagination();
        }

        displayGists(gists) {
            const tbody = this.elements.table.querySelector('tbody');
            tbody.innerHTML = gists.map(gist => `
                <tr>
                    <td>
                        <a href="${gist.html_url}" target="_blank">${gist.description || 'No description'}</a>
                        <div class="file-list">${Object.keys(gist.files).join(', ')}</div>
                    </td>
                    <td>${Object.keys(gist.files).length}</td>
                    <td>${this.formatDate(gist.created_at)}</td>
                    <td>${this.formatDate(gist.updated_at)}</td>
                </tr>
            `).join('');
        }

        formatDate(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0]; // Returns date in YYYY-MM-DD format
        }

        updatePagination() {
            const visibleRows = this.elements.table.querySelectorAll('tbody tr:not([style*="display: none"])');
            this.totalPages = Math.ceil(visibleRows.length / this.perPage);
            this.currentPage = Math.min(this.currentPage, this.totalPages);
            this.currentPage = Math.max(this.currentPage, 1);

            visibleRows.forEach((row, index) => {
                row.style.display = (index >= (this.currentPage - 1) * this.perPage && index < this.currentPage * this.perPage) ? '' : 'none';
            });

            this.elements.prevPage.disabled = this.currentPage === 1;
            this.elements.nextPage.disabled = this.currentPage === this.totalPages;
            this.elements.pageInfo.textContent = `Page ${this.currentPage} of ${this.totalPages}`;
        }

        changePage(delta) {
            this.currentPage += delta;
            this.updatePagination();
        }

        sortTable(th, initialDirection = null) {
            const tbody = this.elements.table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const columnIndex = Array.from(th.parentNode.children).indexOf(th);

            let currentDirection = th.dataset.sortDirection;

            if (initialDirection) {
                currentDirection = initialDirection;
            } else if (currentDirection === '' || currentDirection === 'desc') {
                currentDirection = 'asc';
            } else {
                currentDirection = 'desc';
            }

            th.dataset.sortDirection = currentDirection;
            
            rows.sort((a, b) => {
                const aValue = a.children[columnIndex].textContent.trim();
                const bValue = b.children[columnIndex].textContent.trim();
                return currentDirection === 'asc'
                    ? aValue.localeCompare(bValue, undefined, {numeric: true, sensitivity: 'base'}) 
                    : bValue.localeCompare(aValue, undefined, {numeric: true, sensitivity: 'base'});
            });

            rows.forEach(row => tbody.appendChild(row));
            this.updateSortIcons(th, currentDirection);
        }

        updateSortIcons(clickedTh, direction) {
            this.elements.table.querySelectorAll('th').forEach(th => {
                const icon = th.querySelector('.sort-icon');
                icon.className = 'sort-icon';
                th.dataset.sortDirection = '';
                th.removeAttribute('aria-sort');
            });

            clickedTh.dataset.sortDirection = direction;
            const icon = clickedTh.querySelector('.sort-icon');
            icon.classList.add(direction);
            clickedTh.setAttribute('aria-sort', direction === 'asc' ? 'ascending' : 'descending');
        }

        showLoading(isLoading) {
            this.elements.loading.textContent = isLoading ? 'Loading...' : '';
        }

        showError(message) {
            this.elements.error.textContent = message;
        }

        updateURL(username) {
            const url = new URL(window.location);
            url.searchParams.set('username', username);
            window.history.pushState({}, '', url);
        }
    }

    new GistViewer();
    </script>
</body>
</html>
